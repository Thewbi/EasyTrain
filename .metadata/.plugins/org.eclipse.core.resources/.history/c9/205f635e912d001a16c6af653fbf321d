package de.wfb.rail.factory;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import gnu.io.CommPort;
import gnu.io.CommPortIdentifier;
import gnu.io.SerialPort;

public class DefaultSerialPortFactory implements Factory<SerialPort> {

	private static final Logger logger = LogManager.getLogger(DefaultSerialPortFactory.class);

	@Override
	public SerialPort create(final Object... args) {
		try {
			return connect((String) args[0]);
		} catch (final Exception e) {
			logger.info(e.getMessage(), e);
		}
		return null;
	}

	private SerialPort connect(final String portName) throws Exception {

		final CommPortIdentifier portIdentifier = CommPortIdentifier.getPortIdentifier(portName);

		if (portIdentifier.isCurrentlyOwned()) {

			System.out.println("Error: Port is currently in use");
			return null;
		}

		// number of milliseconds to wait for the port to open
		final int connectionTimeoutInMillis = 2000;

		final CommPort commPort = portIdentifier.open(APPLICATION_NAME, connectionTimeoutInMillis);

		if (!(commPort instanceof SerialPort)) {
			System.out.println("Error: Only serial ports are handled by this example.");
			return null;
		}

		final SerialPort serialPort = (SerialPort) commPort;
		serialPort.setSerialPortParams(BAUD_RATE, DATA_BITS, STOP_BITS, PARITY);

		return serialPort;
	}

}
